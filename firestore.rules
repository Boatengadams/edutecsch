rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ==============================
       CORE AUTH HELPERS
    ============================== */

    function isSignedIn() {
      return request.auth != null;
    }

    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }

    function userExists(uid) {
      return exists(/databases/$(database)/documents/users/$(uid));
    }

    function isSuperAdmin() {
      return request.auth.token.email in [
        'bagsgraphics4g@gmail.com',
        'boatengadams4g@gmail.com'
      ];
    }

    function isAdmin() {
      return isSuperAdmin() ||
        (userExists(request.auth.uid) &&
         userDoc(request.auth.uid).data.role == 'admin');
    }

    function isApproved() {
      return isSignedIn() &&
        (isSuperAdmin() ||
         (userExists(request.auth.uid) &&
          userDoc(request.auth.uid).data.status == 'approved'));
    }

    /* ==============================
       ACTIVATION VAULT
    ============================== */

    // Whitelist of valid tokens embedded in the security kernel
    function isValidToken(tokenId) {
      return tokenId in [
        // TRIAL PROTOCOLS (7 Days)
        'EDUTEC-TRIAL-8822-XP', 
        'EDUTEC-TRIAL-4491-ZT', 
        'EDUTEC-TRIAL-1103-QA',
        
        // TERMLY PROTOCOLS (4 Months)
        'EDUTEC-TERM-X992-LK', 
        'EDUTEC-TERM-Z112-MW', 
        'EDUTEC-TERM-K443-PS',
        'EDUTEC-TERM-P009-RV', 
        'EDUTEC-TERM-Q887-NB', 
        'EDUTEC-TERM-W332-XC',
        'EDUTEC-TERM-L771-BH', 
        'EDUTEC-TERM-R554-MJ', 
        'EDUTEC-TERM-T221-OP',
        
        // MONTHLY PROTOCOLS (1 Month)
        'EDUTEC-MONT-M123-SV', 
        'EDUTEC-MONT-M456-RX',
        
        // YEARLY PROTOCOLS (1 Year)
        'EDUTEC-YEAR-ULT-Z99', 
        'EDUTEC-YEAR-ULT-W88', 
        'EDUTEC-YEAR-ULT-P77'
      ];
    }

    match /activationTokens/{tokenId} {
      // Allow any signed-in user to check if a token they typed is valid/used
      allow get: if isSignedIn();
      
      // Prevent unauthorized creation/seeding of tokens
      // Only SuperAdmins can register new potential keys in the DB if needed
      allow create: if isSuperAdmin() && isValidToken(tokenId);
      
      // Activation Transaction Logic
      allow update: if isAdmin() 
        && isValidToken(tokenId)
        && resource.data.isUsed == false
        && request.resource.data.isUsed == true
        && request.resource.data.usedBy == request.auth.uid;
    }

    /* ==============================
       USERS
    ============================== */

    match /users/{userId} {
      allow get: if isSignedIn() &&
        (request.auth.uid == userId || isAdmin());

      allow list: if isAdmin();

      allow create: if isSignedIn()
        && request.auth.uid == userId
        && request.resource.data.role in ['student', 'teacher', 'parent']
        && request.resource.data.status == 'pending';

      allow update: if isAdmin()
        || (isSignedIn()
            && request.auth.uid == userId
            && request.resource.data.role == resource.data.role
            && request.resource.data.status == resource.data.status);

      allow delete: if isAdmin();
    }

    /* ==============================
       USER ACTIVITY LOGS (WRITE-ONCE)
    ============================== */

    match /userActivity/{logId} {
      allow create: if isSignedIn()
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.action is string
        && request.resource.data.action.size() <= 100;

      allow read, list: if isAdmin();
      allow update, delete: if false;
    }

    /* ==============================
       SCHOOL CONFIG
    ============================== */

    match /schoolConfig/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /* ==============================
       CONVERSATIONS
    ============================== */

    match /conversations/{conversationId} {
      allow create: if isApproved();

      allow read, update: if isApproved()
        && request.auth.uid in resource.data.participantUids;

      match /messages/{messageId} {
        allow read: if isApproved()
          && request.auth.uid in
            get(/databases/$(database)/documents/conversations/$(conversationId))
              .data.participantUids;

        allow create: if isApproved()
          && request.resource.data.senderId == request.auth.uid
          && request.resource.data.text is string
          && request.resource.data.text.size() <= 2000;
      }
    }

    /* ==============================
       ASSIGNMENTS
    ============================== */

    match /assignments/{assignmentId} {
      allow read: if isApproved();

      allow create: if isApproved()
        && userDoc(request.auth.uid).data.role == 'teacher'
        && request.resource.data.teacherId == request.auth.uid;

      allow update, delete: if isAdmin()
        || (userDoc(request.auth.uid).data.role == 'teacher'
            && resource.data.teacherId == request.auth.uid);
    }

    /* ==============================
       SUBMISSIONS
    ============================== */

    match /submissions/{submissionId} {
      allow create: if isApproved()
        && userDoc(request.auth.uid).data.role == 'student'
        && request.resource.data.studentId == request.auth.uid;

      allow read: if isAdmin()
        || request.auth.uid == resource.data.studentId
        || request.auth.uid == resource.data.teacherId;

      allow update: if isAdmin()
        || (userDoc(request.auth.uid).data.role == 'teacher'
            && request.auth.uid == resource.data.teacherId);

      allow delete: if isAdmin();
    }

    /* ==============================
       GENERATED / AI CONTENT
    ============================== */

    match /generatedContent/{contentId} {
      allow read: if isApproved();

      allow create: if isApproved()
        && userDoc(request.auth.uid).data.role == 'teacher'
        && request.resource.data.prompt is string
        && request.resource.data.prompt.size() <= 4000;

      allow update, delete: if isAdmin();
    }

    /* ==============================
       DEFAULT DENY
    ============================== */

    match /{document=**} {
      allow read, write: if false;
    }
  }
}