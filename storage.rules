rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserData() {
      return firestore.get(/databases/(default)/documents/users/$(request.auth.uid)).data;
    }

    function isApproved() {
      let data = getUserData();
      return data.status == 'approved' || data.role == 'admin';
    }

    function isTeacher() {
      return getUserData().role == 'teacher';
    }

    function isAdmin() {
      let data = getUserData();
      return data.role == 'admin' || data.get('isAlsoAdmin', false) == true;
    }

    // Individual Profiles: Owners only
    match /users/{userId}/{allPaths=**} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == userId && 
                    request.resource.size < 5 * 1024 * 1024 &&
                    request.resource.contentType.matches('image/.*');
    }

    // DM Attachments: Participant-Only Access
    match /direct_messages/{convoId}/{allPaths=**} {
      allow read, write: if isApproved() && 
        request.auth.uid in firestore.get(/databases/(default)/documents/conversations/$(convoId)).data.participantUids;
    }

    // Classroom Assets: Teachers and Admins
    match /teachingMaterials/{allPaths=**} {
      allow read: if isApproved();
      allow write: if isApproved() && (isTeacher() || isAdmin());
    }

    match /assignments/{id}/{allPaths=**} {
      allow read: if isApproved();
      allow write: if isApproved() && isTeacher();
    }

    // Broadcast Flyers: School-Wide Read, Admin-Only Write
    match /flyers/{allPaths=**} {
      allow read: if isApproved();
      allow write: if isApproved() && isAdmin() &&
                    request.resource.size < 10 * 1024 * 1024;
    }

    // System Config: Admin Only
    match /schoolConfig/{allPaths=**} {
      allow read: if true;
      allow write: if isApproved() && isAdmin();
    }

    // Video Storage: Size restricted high-bandwidth content
    match /videoContent/{userId}/{allPaths=**} {
      allow read: if isApproved();
      allow write: if isApproved() && (request.auth.uid == userId) && (isTeacher() || isAdmin()) &&
                    request.resource.size < 100 * 1024 * 1024;
    }
  }
}